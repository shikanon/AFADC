<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>角色IP形象 - AI漫剧快造</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        tertiary: '#06b6d4',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        'text-primary': '#1f2937',
                        'text-secondary': '#6b7280',
                        'bg-light': '#f8fafc',
                        'border-light': '#e5e7eb'
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }
        
        .character-card-hover:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease-in-out;
        }
        
        .nav-item-active {
            background-color: theme('colors.primary');
            color: white;
        }
        
        .nav-item-hover:hover {
            background-color: theme('colors.bg-light');
            color: theme('colors.primary');
        }
        
        .search-focus:focus {
            outline: none;
            border-color: theme('colors.primary');
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .form-input-focus:focus {
            outline: none;
            border-color: theme('colors.primary');
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }
        
        .upload-area {
            border: 2px dashed theme('colors.border-light');
            transition: all 0.3s ease;
        }
        
        .upload-area:hover {
            border-color: theme('colors.primary');
            background-color: rgba(99, 102, 241, 0.05);
        }
        
        .upload-area.dragover {
            border-color: theme('colors.primary');
            background-color: rgba(99, 102, 241, 0.1);
        }
    </style>
</head>
<body class="bg-bg-light min-h-screen">
    <!-- 顶部导航栏 -->
    <header id="top-navbar" class="fixed top-0 left-0 right-0 bg-white border-b border-border-light h-16 z-50">
        <div class="flex items-center justify-between h-full px-6">
            <!-- Logo和产品名称 -->
            <div id="logo-section" class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
                    <i class="fas fa-magic text-white text-sm"></i>
                </div>
                <h1 class="text-xl font-bold text-text-primary">AI漫剧快造</h1>
            </div>
            
            <!-- 全局搜索 -->
            <div id="global-search" class="flex-1 max-w-md mx-8">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary text-sm"></i>
                    <input type="text" id="global-search-input" placeholder="搜索项目、工作空间..." 
                           class="w-full pl-10 pr-4 py-2 border border-border-light rounded-lg search-focus">
                </div>
            </div>
            
            <!-- 右侧操作区 -->
            <div id="header-actions" class="flex items-center space-x-4">
                <!-- 消息通知 -->
                <button id="notification-btn" class="relative p-2 text-text-secondary hover:text-primary">
                    <i class="fas fa-bell text-lg"></i>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-danger rounded-full"></span>
                </button>
                
                <!-- 用户头像 -->
                <div id="user-menu" class="relative">
                    <button id="user-avatar-btn" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-bg-light">
                        <img src="https://s.coze.cn/image/Ha7BrYdYGYA/" 
                             alt="用户头像" class="w-8 h-8 rounded-full" data-category="人物">
                        <span class="text-sm text-text-primary">张小明</span>
                        <i class="fas fa-chevron-down text-xs text-text-secondary"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 左侧菜单 -->
    <aside id="sidebar" class="fixed left-0 top-16 bottom-0 w-60 bg-white border-r border-border-light sidebar-transition z-40">
        <nav id="sidebar-nav" class="p-4 space-y-2">
            <!-- 工作空间 -->
            <div id="workspace-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">工作空间</h3>
                <div class="space-y-1">
                    <a href="P-WORKSPACE_LIST.html" id="nav-workspace-list" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-layer-group w-4"></i>
                        <span>工作空间管理</span>
                    </a>
                </div>
            </div>
            
            <!-- 项目管理 -->
            <div id="project-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">项目管理</h3>
                <div class="space-y-1">
                    <a href="P-PROJECT_LIST.html" id="nav-project-list" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-folder w-4"></i>
                        <span>项目列表</span>
                    </a>
                </div>
            </div>
            
            <!-- 制作流程 -->
            <div id="workflow-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">制作流程</h3>
                <div class="space-y-1">
                    <a href="P-SCRIPT_INFO.html" id="nav-script-info" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-file-alt w-4"></i>
                        <span>剧本信息</span>
                    </a>
                    <a href="P-CHARACTER_GENERATION.html" id="nav-character" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-active">
                        <i class="fas fa-user-friends w-4"></i>
                        <span>角色IP形象</span>
                    </a>
                    <a href="P-VOICE_SELECTION.html" id="nav-voice" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-microphone w-4"></i>
                        <span>音色选择</span>
                    </a>
                    <a href="P-SCENARIO_EDITOR.html" id="nav-scenario" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-film w-4"></i>
                        <span>分镜脚本</span>
                    </a>
                    <a href="P-IMAGE_GENERATION.html" id="nav-image" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-image w-4"></i>
                        <span>分镜画面</span>
                    </a>
                    <a href="P-VIDEO_GENERATION.html" id="nav-video" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-video w-4"></i>
                        <span>分镜视频</span>
                    </a>
                    <a href="P-VIDEO_EXPORT.html" id="nav-export" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-download w-4"></i>
                        <span>视频导出</span>
                    </a>
                </div>
            </div>
            
            <!-- 素材库 -->
            <div id="material-section">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">素材库</h3>
                <div class="space-y-1">
                    <a href="P-MATERIAL_LIBRARY.html" id="nav-material" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-palette w-4"></i>
                        <span>素材库管理</span>
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- 主内容区 -->
    <main id="main-content" class="ml-60 mt-16 p-6 min-h-screen">
        <!-- 页面头部 -->
        <div id="page-header" class="mb-6">
            <!-- 面包屑导航 -->
            <nav id="breadcrumb" class="mb-4">
                <ol class="flex items-center space-x-2 text-sm text-text-secondary">
                    <li><a href="P-PROJECT_LIST.html" class="hover:text-primary">项目管理</a></li>
                    <li><i class="fas fa-chevron-right text-xs"></i></li>
                    <li><span class="text-text-primary">樱花之恋</span></li>
                    <li><i class="fas fa-chevron-right text-xs"></i></li>
                    <li><span class="text-text-primary">角色IP形象</span></li>
                </ol>
            </nav>
            
            <!-- 页面标题和操作 -->
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-text-primary mb-2">角色IP形象</h1>
                    <p class="text-text-secondary">创建和管理您的角色形象</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="create-character-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fas fa-plus mr-2"></i>新建角色
                    </button>
                    <button id="save-characters-btn" class="bg-success text-white px-6 py-2 rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                    <button id="next-step-btn" class="bg-secondary text-white px-6 py-2 rounded-lg hover:bg-secondary/90 transition-colors">
                        <span>下一步</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- 角色列表区域 -->
        <div id="character-list-section" class="mb-8">
            <h2 class="text-lg font-semibold text-text-primary mb-4">已创建角色</h2>
            <div id="character-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- 角色卡片1 -->
                <div id="character-card-1" class="bg-white rounded-xl shadow-card character-card-hover">
                    <div class="relative">
                        <img src="https://s.coze.cn/image/OC7WpEsr31g/" 
                             alt="角色预览图" class="w-full h-48 object-cover rounded-t-xl" data-category="人物">
                        <div class="absolute top-3 right-3">
                            <button class="edit-character-btn bg-white/90 text-text-secondary hover:text-primary p-2 rounded-lg shadow-md" 
                                    data-character-id="char1">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-semibold text-text-primary mb-2">樱花少女</h3>
                        <p class="text-sm text-text-secondary mb-4 line-clamp-2">穿着粉色连衣裙的少女，长发飘飘，温柔可爱，樱花般的美好</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-text-secondary">3个视角</span>
                            <button class="delete-character-btn text-text-secondary hover:text-danger text-sm" 
                                    data-character-id="char1">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 角色卡片2 -->
                <div id="character-card-2" class="bg-white rounded-xl shadow-card character-card-hover">
                    <div class="relative">
                        <img src="https://s.coze.cn/image/GzgmJ7FKNzs/" 
                             alt="角色预览图" class="w-full h-48 object-cover rounded-t-xl" data-category="人物">
                        <div class="absolute top-3 right-3">
                            <button class="edit-character-btn bg-white/90 text-text-secondary hover:text-primary p-2 rounded-lg shadow-md" 
                                    data-character-id="char2">
                                <i class="fas fa-edit"></i>
                            </button>
                        </div>
                    </div>
                    <div class="p-5">
                        <h3 class="font-semibold text-text-primary mb-2">阳光少年</h3>
                        <p class="text-sm text-text-secondary mb-4 line-clamp-2">穿着校服的高中男生，阳光开朗，运动型的帅气少年</p>
                        <div class="flex items-center justify-between">
                            <span class="text-xs text-text-secondary">3个视角</span>
                            <button class="delete-character-btn text-text-secondary hover:text-danger text-sm" 
                                    data-character-id="char2">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 新建角色卡片 -->
                <div id="create-new-character-card" class="border-2 border-dashed border-border-light rounded-xl p-8 text-center hover:border-primary/50 hover:bg-primary/5 transition-colors cursor-pointer">
                    <div class="w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center mx-auto mb-4">
                        <i class="fas fa-user-plus text-primary text-2xl"></i>
                    </div>
                    <h3 class="font-semibold text-text-primary mb-2">创建新角色</h3>
                    <p class="text-sm text-text-secondary">使用AI生成独特的角色形象</p>
                </div>
            </div>
        </div>

        <!-- 角色编辑/创建表单 -->
        <div id="character-editor" class="bg-white rounded-xl shadow-card p-6 hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-lg font-semibold text-text-primary" id="editor-title">创建新角色</h2>
                <button id="close-editor-btn" class="text-text-secondary hover:text-text-primary">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <form id="character-form" class="space-y-6">
                <!-- 角色基本信息 -->
                <div class="space-y-4">
                    <div>
                        <label for="character-name" class="block text-sm font-medium text-text-primary mb-2">角色名称 *</label>
                        <input type="text" id="character-name" name="character-name" 
                               class="w-full px-4 py-2 border border-border-light rounded-lg form-input-focus" 
                               placeholder="请输入角色名称" required>
                    </div>

                    <div>
                        <label for="character-description" class="block text-sm font-medium text-text-primary mb-2">角色特征描述 *</label>
                        <textarea id="character-description" name="character-description" rows="4"
                                  class="w-full px-4 py-2 border border-border-light rounded-lg form-input-focus resize-none" 
                                  placeholder="请详细描述角色的外貌、性格、服装等特征..." required></textarea>
                    </div>

                    <!-- 参考图上传 -->
                    <div>
                        <label class="block text-sm font-medium text-text-primary mb-2">参考图上传（可选）</label>
                        <div id="reference-upload-area" class="upload-area rounded-lg p-6 text-center cursor-pointer">
                            <input type="file" id="reference-image-input" accept="image/*" class="hidden">
                            <i class="fas fa-cloud-upload-alt text-3xl text-text-secondary mb-3"></i>
                            <p class="text-sm text-text-primary mb-1">点击上传参考图片</p>
                            <p class="text-xs text-text-secondary">支持 JPG、PNG 格式，最大 10MB</p>
                        </div>
                        <div id="reference-preview" class="mt-3 hidden">
                            <img id="reference-image-preview" src="" alt="参考图预览" 
                                 class="w-32 h-32 object-cover rounded-lg border border-border-light">
                            <button type="button" id="remove-reference-btn" class="ml-3 text-danger hover:text-danger/80 text-sm">
                                <i class="fas fa-trash mr-1"></i>移除
                            </button>
                        </div>
                    </div>
                </div>

                <!-- 生成选项 -->
                <div class="border-t pt-6">
                    <div class="flex items-center justify-between space-x-4">
                        <button type="button" id="generate-character-btn" 
                                class="flex-1 bg-primary text-white py-3 rounded-lg hover:bg-primary/90 transition-colors font-medium">
                            <i class="fas fa-magic mr-2"></i>AI生成角色
                        </button>
                        <button type="button" id="upload-custom-btn" 
                                class="px-6 py-3 border border-border-light text-text-primary rounded-lg hover:border-primary hover:text-primary transition-colors">
                            <i class="fas fa-upload mr-2"></i>手动上传
                        </button>
                    </div>
                </div>
            </form>

            <!-- 生成结果预览 -->
            <div id="generation-result" class="mt-6 border-t pt-6 hidden">
                <h3 class="text-lg font-semibold text-text-primary mb-4">生成结果</h3>
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="text-center">
                        <img id="character-front" src="" alt="正面视角" 
                             class="w-full h-48 object-cover rounded-lg border border-border-light mb-2">
                        <p class="text-sm text-text-secondary">正面视角</p>
                    </div>
                    <div class="text-center">
                        <img id="character-side" src="" alt="侧面视角" 
                             class="w-full h-48 object-cover rounded-lg border border-border-light mb-2">
                        <p class="text-sm text-text-secondary">侧面视角</p>
                    </div>
                    <div class="text-center">
                        <img id="character-45" src="" alt="45度视角" 
                             class="w-full h-48 object-cover rounded-lg border border-border-light mb-2">
                        <p class="text-sm text-text-secondary">45度视角</p>
                    </div>
                </div>

                <div class="flex items-center justify-end space-x-3">
                    <button type="button" id="regenerate-character-btn" 
                            class="px-6 py-2 border border-border-light text-text-primary rounded-lg hover:border-primary hover:text-primary transition-colors">
                        <i class="fas fa-redo mr-2"></i>重新生成
                    </button>
                    <button type="button" id="save-character-btn" 
                            class="px-6 py-2 bg-success text-white rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-save mr-2"></i>保存角色
                    </button>
                </div>
            </div>
        </div>

        <!-- 底部操作区 -->
        <div id="bottom-actions" class="bg-white rounded-xl shadow-card p-4">
            <div class="flex items-center justify-between">
                <button id="prev-step-btn" class="px-6 py-2 border border-border-light text-text-primary rounded-lg hover:border-primary hover:text-primary transition-colors">
                    <i class="fas fa-arrow-left mr-2"></i>上一步
                </button>
                <div class="flex items-center space-x-3">
                    <button id="save-bottom-btn" class="px-6 py-2 bg-success text-white rounded-lg hover:bg-success/90 transition-colors">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                    <button id="next-bottom-btn" class="px-6 py-2 bg-secondary text-white rounded-lg hover:bg-secondary/90 transition-colors">
                        <span>下一步</span>
                        <i class="fas fa-arrow-right ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- 删除确认弹窗 -->
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-md">
                <div class="p-6">
                    <div class="text-center">
                        <div class="w-12 h-12 bg-danger/10 rounded-full flex items-center justify-center mx-auto mb-4">
                            <i class="fas fa-exclamation-triangle text-danger text-xl"></i>
                        </div>
                        <h3 class="text-lg font-semibold text-text-primary mb-2">确认删除</h3>
                        <p class="text-sm text-text-secondary mb-6">确定要删除这个角色吗？删除后无法恢复。</p>
                        <div class="flex items-center justify-center space-x-3">
                            <button id="cancel-delete-btn" 
                                    class="px-4 py-2 border border-border-light rounded-lg text-text-secondary hover:border-primary hover:text-primary">
                                取消
                            </button>
                            <button id="confirm-delete-btn" 
                                    class="px-4 py-2 bg-danger text-white rounded-lg hover:bg-danger/90">
                                删除
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 手动上传弹窗 -->
    <div id="upload-custom-modal" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-lg">
                <div class="p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h3 class="text-lg font-semibold text-text-primary">手动上传角色形象</h3>
                        <button id="close-upload-modal-btn" class="text-text-secondary hover:text-text-primary">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form id="upload-custom-form" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">正面视角图片 *</label>
                            <div class="upload-area rounded-lg p-4 text-center cursor-pointer">
                                <input type="file" id="front-image-input" accept="image/*" class="hidden">
                                <i class="fas fa-cloud-upload-alt text-2xl text-text-secondary mb-2"></i>
                                <p class="text-sm text-text-primary">点击上传正面视角</p>
                            </div>
                            <img id="front-image-preview" src="" alt="正面预览" class="mt-2 w-24 h-24 object-cover rounded-lg hidden">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">侧面视角图片 *</label>
                            <div class="upload-area rounded-lg p-4 text-center cursor-pointer">
                                <input type="file" id="side-image-input" accept="image/*" class="hidden">
                                <i class="fas fa-cloud-upload-alt text-2xl text-text-secondary mb-2"></i>
                                <p class="text-sm text-text-primary">点击上传侧面视角</p>
                            </div>
                            <img id="side-image-preview" src="" alt="侧面预览" class="mt-2 w-24 h-24 object-cover rounded-lg hidden">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-text-primary mb-2">45度视角图片 *</label>
                            <div class="upload-area rounded-lg p-4 text-center cursor-pointer">
                                <input type="file" id="angle45-image-input" accept="image/*" class="hidden">
                                <i class="fas fa-cloud-upload-alt text-2xl text-text-secondary mb-2"></i>
                                <p class="text-sm text-text-primary">点击上传45度视角</p>
                            </div>
                            <img id="angle45-image-preview" src="" alt="45度预览" class="mt-2 w-24 h-24 object-cover rounded-lg hidden">
                        </div>
                        
                        <div class="flex items-center justify-end space-x-3 pt-4">
                            <button type="button" id="cancel-upload-btn" 
                                    class="px-4 py-2 border border-border-light rounded-lg text-text-secondary hover:border-primary hover:text-primary">
                                取消
                            </button>
                            <button type="submit" 
                                    class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90">
                                上传角色
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数的辅助函数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 获取URL参数
            const params = getUrlParams();
            let currentProjectId = params.projectId || 'default';
            let currentEditingCharacterId = null;
            let characterToDelete = null;

            // 模拟角色数据
            const characters = {
                'char1': {
                    id: 'char1',
                    name: '樱花少女',
                    description: '穿着粉色连衣裙的少女，长发飘飘，温柔可爱，樱花般的美好',
                    images: [
                        'https://s.coze.cn/image/PDuGC7GmwBY/',
                        'https://s.coze.cn/image/wz8FagV1IH0/',
                        'https://s.coze.cn/image/bz3lyoGdyuo/'
                    ]
                },
                'char2': {
                    id: 'char2',
                    name: '阳光少年',
                    description: '穿着校服的高中男生，阳光开朗，运动型的帅气少年',
                    images: [
                        'https://s.coze.cn/image/qwUWSRSD8vs/',
                        'https://s.coze.cn/image/pqU0BBLLjjg/',
                        'https://s.coze.cn/image/qte30jFf5ZE/'
                    ]
                }
            };

            // 页面导航事件
            document.querySelector('#nav-workspace-list').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'P-WORKSPACE_LIST.html';
            });

            document.querySelector('#nav-project-list').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'P-PROJECT_LIST.html';
            });

            document.querySelector('#nav-script-info').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-SCRIPT_INFO.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-voice').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-VOICE_SELECTION.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-scenario').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-SCENARIO_EDITOR.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-image').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-IMAGE_GENERATION.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-video').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-VIDEO_GENERATION.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-export').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = `P-VIDEO_EXPORT.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#nav-material').addEventListener('click', function(e) {
                e.preventDefault();
                window.location.href = 'P-MATERIAL_LIBRARY.html';
            });

            // 上一步/下一步按钮事件
            document.querySelector('#prev-step-btn').addEventListener('click', function() {
                window.location.href = `P-SCRIPT_INFO.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#next-step-btn').addEventListener('click', function() {
                window.location.href = `P-VOICE_SELECTION.html?projectId=${currentProjectId}`;
            });

            document.querySelector('#next-bottom-btn').addEventListener('click', function() {
                window.location.href = `P-VOICE_SELECTION.html?projectId=${currentProjectId}`;
            });

            // 保存按钮事件
            document.querySelector('#save-characters-btn').addEventListener('click', function() {
                console.log('保存所有角色');
                // 显示保存成功提示
                alert('角色保存成功！');
            });

            document.querySelector('#save-bottom-btn').addEventListener('click', function() {
                console.log('保存所有角色');
                // 显示保存成功提示
                alert('角色保存成功！');
            });

            // 新建角色按钮事件
            document.querySelector('#create-character-btn').addEventListener('click', function() {
                openCharacterEditor();
            });

            document.querySelector('#create-new-character-card').addEventListener('click', function() {
                openCharacterEditor();
            });

            // 编辑角色按钮事件
            document.querySelectorAll('.edit-character-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    const characterId = this.dataset.characterId;
                    openCharacterEditor(characterId);
                });
            });

            // 删除角色按钮事件
            document.querySelectorAll('.delete-character-btn').forEach(btn => {
                btn.addEventListener('click', function(e) {
                    e.stopPropagation();
                    characterToDelete = this.dataset.characterId;
                    openDeleteConfirmModal();
                });
            });

            // 关闭编辑器
            document.querySelector('#close-editor-btn').addEventListener('click', function() {
                closeCharacterEditor();
            });

            // 生成角色按钮事件
            document.querySelector('#generate-character-btn').addEventListener('click', function() {
                generateCharacter();
            });

            // 重新生成角色按钮事件
            document.querySelector('#regenerate-character-btn').addEventListener('click', function() {
                generateCharacter();
            });

            // 保存角色按钮事件
            document.querySelector('#save-character-btn').addEventListener('click', function() {
                saveCharacter();
            });

            // 手动上传按钮事件
            document.querySelector('#upload-custom-btn').addEventListener('click', function() {
                openUploadCustomModal();
            });

            // 参考图上传事件
            document.querySelector('#reference-upload-area').addEventListener('click', function() {
                document.querySelector('#reference-image-input').click();
            });

            document.querySelector('#reference-image-input').addEventListener('change', function(e) {
                if (e.target.files && e.target.files[0]) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        document.querySelector('#reference-image-preview').src = e.target.result;
                        document.querySelector('#reference-preview').classList.remove('hidden');
                        document.querySelector('#reference-upload-area').classList.add('hidden');
                    };
                    reader.readAsDataURL(e.target.files[0]);
                }
            });

            // 移除参考图
            document.querySelector('#remove-reference-btn').addEventListener('click', function() {
                document.querySelector('#reference-image-input').value = '';
                document.querySelector('#reference-preview').classList.add('hidden');
                document.querySelector('#reference-upload-area').classList.remove('hidden');
            });

            // 删除确认弹窗事件
            document.querySelector('#cancel-delete-btn').addEventListener('click', function() {
                closeDeleteConfirmModal();
            });

            document.querySelector('#confirm-delete-btn').addEventListener('click', function() {
                deleteCharacter();
            });

            document.querySelector('#delete-confirm-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDeleteConfirmModal();
                }
            });

            // 手动上传弹窗事件
            document.querySelector('#close-upload-modal-btn').addEventListener('click', function() {
                closeUploadCustomModal();
            });

            document.querySelector('#cancel-upload-btn').addEventListener('click', function() {
                closeUploadCustomModal();
            });

            document.querySelector('#upload-custom-modal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeUploadCustomModal();
                }
            });

            // 手动上传表单提交
            document.querySelector('#upload-custom-form').addEventListener('submit', function(e) {
                e.preventDefault();
                console.log('手动上传角色形象');
                alert('角色上传成功！');
                closeUploadCustomModal();
                closeCharacterEditor();
            });

            // 手动上传图片预览
            ['front', 'side', 'angle45'].forEach(type => {
                const input = document.querySelector(`#${type}-image-input`);
                const preview = document.querySelector(`#${type}-image-preview`);
                
                input.addEventListener('change', function(e) {
                    if (e.target.files && e.target.files[0]) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            preview.src = e.target.result;
                            preview.classList.remove('hidden');
                        };
                        reader.readAsDataURL(e.target.files[0]);
                    }
                });
            });

            // 函数定义
            function openCharacterEditor(characterId = null) {
                currentEditingCharacterId = characterId;
                const editor = document.querySelector('#character-editor');
                const title = document.querySelector('#editor-title');
                const form = document.querySelector('#character-form');
                
                // 清空表单
                form.reset();
                document.querySelector('#reference-preview').classList.add('hidden');
                document.querySelector('#reference-upload-area').classList.remove('hidden');
                document.querySelector('#generation-result').classList.add('hidden');
                
                if (characterId) {
                    // 编辑模式
                    title.textContent = '编辑角色';
                    const character = characters[characterId];
                    document.querySelector('#character-name').value = character.name;
                    document.querySelector('#character-description').value = character.description;
                } else {
                    // 创建模式
                    title.textContent = '创建新角色';
                }
                
                editor.classList.remove('hidden');
                editor.scrollIntoView({ behavior: 'smooth' });
            }

            function closeCharacterEditor() {
                document.querySelector('#character-editor').classList.add('hidden');
                currentEditingCharacterId = null;
            }

            function generateCharacter() {
                console.log('开始AI生成角色');
                
                // 显示生成中状态
                const generateBtn = document.querySelector('#generate-character-btn');
                const originalText = generateBtn.innerHTML;
                generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>生成中...';
                generateBtn.disabled = true;
                
                // 模拟生成过程
                setTimeout(() => {
                    // 显示生成结果
                    document.querySelector('#character-front').src = 'https://s.coze.cn/image/qveN3EUygCk/';
                    document.querySelector('#character-side').src = 'https://s.coze.cn/image/GMhVRbRtAd8/';
                    document.querySelector('#character-45').src = 'https://s.coze.cn/image/FRLfbcu_s3w/';
                    document.querySelector('#generation-result').classList.remove('hidden');
                    
                    // 恢复按钮状态
                    generateBtn.innerHTML = originalText;
                    generateBtn.disabled = false;
                }, 2000);
            }

            function saveCharacter() {
                console.log('保存角色');
                
                const characterName = document.querySelector('#character-name').value;
                const characterDescription = document.querySelector('#character-description').value;
                
                if (!characterName || !characterDescription) {
                    alert('请填写角色名称和描述');
                    return;
                }
                
                // 模拟保存
                alert('角色保存成功！');
                closeCharacterEditor();
                
                // 这里应该刷新角色列表
                console.log('刷新角色列表');
            }

            function openDeleteConfirmModal() {
                document.querySelector('#delete-confirm-modal').classList.remove('hidden');
            }

            function closeDeleteConfirmModal() {
                document.querySelector('#delete-confirm-modal').classList.add('hidden');
                characterToDelete = null;
            }

            function deleteCharacter() {
                if (characterToDelete) {
                    console.log('删除角色:', characterToDelete);
                    // 这里应该从角色列表中移除该角色
                    delete characters[characterToDelete];
                    alert('角色删除成功！');
                    closeDeleteConfirmModal();
                    
                    // 这里应该刷新角色列表
                    console.log('刷新角色列表');
                }
            }

            function openUploadCustomModal() {
                document.querySelector('#upload-custom-modal').classList.remove('hidden');
            }

            function closeUploadCustomModal() {
                document.querySelector('#upload-custom-modal').classList.add('hidden');
                // 清空上传表单
                document.querySelector('#upload-custom-form').reset();
                ['front', 'side', 'angle45'].forEach(type => {
                    document.querySelector(`#${type}-image-preview`).classList.add('hidden');
                });
            }
        });
    </script>
</body>
</html>