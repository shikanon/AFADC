<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片编辑 - AI漫剧速成工场</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#8B5CF6',
                        tertiary: '#10B981',
                        success: '#22C55E',
                        danger: '#EF4444',
                        warning: '#F59E0B',
                        info: '#06B6D4',
                        'text-primary': '#1F2937',
                        'text-secondary': '#6B7280',
                        'bg-primary': '#F8FAFC',
                        'bg-secondary': '#F1F5F9',
                        'border-light': '#E2E8F0',
                        'border-medium': '#CBD5E1'
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                        'modal': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)'
                    }
                }
            }
        }
    </script>
    <style>
        .modal-backdrop {
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
        }
        
        .modal-enter {
            animation: modalEnter 0.3s ease-out;
        }
        
        @keyframes modalEnter {
            from {
                opacity: 0;
                transform: scale(0.95) translateY(-10px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }
        
        .chat-message {
            animation: messageSlideIn 0.3s ease-out;
        }
        
        @keyframes messageSlideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .loading-dots::after {
            content: '';
            animation: dots 1.5s infinite;
        }
        
        @keyframes dots {
            0%, 20% { content: ''; }
            40% { content: '.'; }
            60% { content: '..'; }
            80%, 100% { content: '...'; }
        }
        
        .image-preview {
            max-height: 400px;
            object-fit: contain;
        }
        
        .chat-container {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-container::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }
        
        .chat-container::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</head>
<body class="bg-bg-primary text-text-primary">
    <!-- 模态弹窗背景 -->
    <div id="modal-backdrop" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50 p-4">
        <!-- 模态弹窗内容 -->
        <div id="image-edit-modal" class="bg-white rounded-lg shadow-modal w-full max-w-4xl max-h-[90vh] modal-enter">
            <!-- 弹窗头部 -->
            <div id="modal-header" class="flex items-center justify-between p-6 border-b border-border-light">
                <div class="flex items-center space-x-3">
                    <div class="w-8 h-8 bg-primary rounded-lg flex items-center justify-center">
                        <i class="fas fa-edit text-white text-sm"></i>
                    </div>
                    <h2 class="text-xl font-semibold text-text-primary">图片编辑</h2>
                </div>
                <button id="close-modal-btn" class="p-2 rounded-lg hover:bg-bg-secondary transition-colors">
                    <i class="fas fa-times text-text-secondary"></i>
                </button>
            </div>

            <!-- 弹窗内容 -->
            <div id="modal-content" class="p-6 overflow-y-auto max-h-[calc(90vh-140px)]">
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- 左侧：图片预览区 -->
                    <div id="image-section" class="space-y-4">
                        <h3 class="text-lg font-medium text-text-primary">图片预览</h3>
                        <div class="bg-bg-secondary rounded-lg p-4 flex items-center justify-center">
                            <img id="preview-image" 
                                 src="https://s.coze.cn/image/yk-fkA8dPwI/" 
                                 alt="分镜画面预览" 
                                 class="image-preview rounded-lg shadow-card"
                                 data-category="艺术">
                        </div>
                        <div class="flex items-center justify-between text-sm text-text-secondary">
                            <span>分镜 ID: <span id="storyboard-id" class="font-medium text-text-primary">SB-001</span></span>
                            <span>尺寸: 1920x1080</span>
                        </div>
                    </div>

                    <!-- 右侧：对话编辑区 -->
                    <div id="chat-section" class="space-y-4">
                        <h3 class="text-lg font-medium text-text-primary">AI 对话编辑</h3>
                        
                        <!-- 历史对话区 -->
                        <div id="chat-history" class="chat-container bg-bg-secondary rounded-lg p-4 space-y-4">
                            <!-- 初始提示 -->
                            <div class="chat-message">
                                <div class="flex items-start space-x-2">
                                    <div class="w-6 h-6 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                        <i class="fas fa-robot text-white text-xs"></i>
                                    </div>
                                    <div class="flex-1">
                                        <div class="bg-white rounded-lg p-3 shadow-card">
                                            <p class="text-sm text-text-primary">你好！我是AI助手，可以帮你编辑这张图片。请告诉我你想要什么样的修改，比如：</p>
                                            <ul class="mt-2 text-sm text-text-secondary space-y-1">
                                                <li>• 调整角色表情</li>
                                                <li>• 修改背景场景</li>
                                                <li>• 改变画风风格</li>
                                                <li>• 调整光线效果</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- 输入区 -->
                        <div id="input-section" class="space-y-3">
                            <div class="relative">
                                <textarea id="edit-prompt" 
                                          placeholder="请输入你的编辑指令..." 
                                          class="w-full pl-4 pr-12 py-3 border border-border-light rounded-lg focus:outline-none focus:ring-2 focus:ring-primary focus:border-transparent resize-none"
                                          rows="3"></textarea>
                                <button id="send-prompt-btn" class="absolute right-3 bottom-3 w-8 h-8 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors flex items-center justify-center">
                                    <i class="fas fa-paper-plane text-sm"></i>
                                </button>
                            </div>
                            
                            <!-- 快捷指令 -->
                            <div id="quick-commands" class="flex flex-wrap gap-2">
                                <button class="quick-command-btn px-3 py-1 bg-white border border-border-light rounded-lg text-sm hover:bg-bg-secondary transition-colors" data-command="让角色微笑">
                                    <i class="fas fa-smile mr-1"></i>让角色微笑
                                </button>
                                <button class="quick-command-btn px-3 py-1 bg-white border border-border-light rounded-lg text-sm hover:bg-bg-secondary transition-colors" data-command="调整光线更明亮">
                                    <i class="fas fa-sun mr-1"></i>调整光线更明亮
                                </button>
                                <button class="quick-command-btn px-3 py-1 bg-white border border-border-light rounded-lg text-sm hover:bg-bg-secondary transition-colors" data-command="更换背景为森林">
                                    <i class="fas fa-tree mr-1"></i>更换背景为森林
                                </button>
                                <button class="quick-command-btn px-3 py-1 bg-white border border-border-light rounded-lg text-sm hover:bg-bg-secondary transition-colors" data-command="提高画质清晰度">
                                    <i class="fas fa-magic mr-1"></i>提高画质清晰度
                                </button>
                            </div>
                        </div>

                        <!-- 生成状态 -->
                        <div id="generation-status" class="hidden bg-bg-secondary rounded-lg p-4">
                            <div class="flex items-center space-x-3">
                                <div class="animate-spin rounded-full h-6 w-6 border-b-2 border-primary"></div>
                                <span class="text-sm text-text-primary">AI正在处理您的请求<span class="loading-dots"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 弹窗底部 -->
            <div id="modal-footer" class="flex items-center justify-end space-x-3 p-6 border-t border-border-light bg-bg-secondary">
                <button id="regenerate-btn" class="px-4 py-2 border border-border-medium text-text-primary rounded-lg hover:bg-white transition-colors">
                    <i class="fas fa-redo mr-2"></i>重新生成
                </button>
                <button id="complete-edit-btn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-blue-600 transition-colors">
                    <i class="fas fa-check mr-2"></i>完成编辑
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数的辅助函数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 获取URL参数
            const params = getUrlParams();
            
            // 如果有分镜ID参数，更新显示
            if(params.storyboardId) {
                document.querySelector('#storyboard-id').textContent = params.storyboardId;
            }

            // 关闭弹窗功能
            function closeModal() {
                // 在实际应用中，这里应该关闭弹窗并返回到父页面
                // 由于这是独立页面，我们模拟关闭行为
                window.history.back();
            }

            // 关闭按钮事件
            document.querySelector('#close-modal-btn').addEventListener('click', closeModal);

            // 点击背景关闭弹窗
            document.querySelector('#modal-backdrop').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeModal();
                }
            });

            // ESC键关闭弹窗
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeModal();
                }
            });

            // 发送指令功能
            function sendPrompt() {
                const promptInput = document.querySelector('#edit-prompt');
                const promptText = promptInput.value.trim();
                
                if (!promptText) {
                    alert('请输入编辑指令');
                    return;
                }

                // 添加用户消息到对话历史
                addMessageToChat(promptText, 'user');
                
                // 清空输入框
                promptInput.value = '';
                
                // 显示生成状态
                showGenerationStatus(true);
                
                // 模拟AI处理
                setTimeout(() => {
                    // 模拟AI回复
                    const aiResponse = "已收到您的指令，正在为您生成新的图片...";
                    addMessageToChat(aiResponse, 'ai');
                    
                    // 模拟图片更新
                    setTimeout(() => {
                        updatePreviewImage();
                        showGenerationStatus(false);
                        
                        // AI完成消息
                        const completionMessage = "图片已更新完成！您可以继续提出修改意见，或者点击"完成编辑"确认更改。";
                        addMessageToChat(completionMessage, 'ai');
                    }, 2000);
                }, 1000);
            }

            // 发送按钮事件
            document.querySelector('#send-prompt-btn').addEventListener('click', sendPrompt);

            // 输入框回车发送（Shift+Enter换行）
            document.querySelector('#edit-prompt').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrompt();
                }
            });

            // 快捷指令按钮事件
            document.querySelectorAll('.quick-command-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const command = this.dataset.command;
                    document.querySelector('#edit-prompt').value = command;
                    sendPrompt();
                });
            });

            // 重新生成功能
            document.querySelector('#regenerate-btn').addEventListener('click', function() {
                const command = "请重新生成这张图片，保持相同的风格和内容";
                document.querySelector('#edit-prompt').value = command;
                sendPrompt();
            });

            // 完成编辑功能
            document.querySelector('#complete-edit-btn').addEventListener('click', function() {
                // 在实际应用中，这里应该保存编辑结果并返回到父页面
                // 由于这是独立页面，我们模拟完成行为
                alert('图片编辑已完成！');
                
                // 返回到父页面（模拟）
                const returnUrl = params.from || 'P-STATIC_CREATE_STEP3.html';
                window.location.href = `${returnUrl}?updatedStoryboardId=${params.storyboardId || 'SB-001'}`;
            });

            // 添加消息到对话历史
            function addMessageToChat(message, sender) {
                const chatHistory = document.querySelector('#chat-history');
                const messageDiv = document.createElement('div');
                messageDiv.className = 'chat-message';
                
                if (sender === 'user') {
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-2 justify-end">
                            <div class="flex-1 max-w-xs">
                                <div class="bg-primary text-white rounded-lg p-3 shadow-card">
                                    <p class="text-sm">${message}</p>
                                </div>
                            </div>
                            <div class="w-6 h-6 bg-gray-400 rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-user text-white text-xs"></i>
                            </div>
                        </div>
                    `;
                } else {
                    messageDiv.innerHTML = `
                        <div class="flex items-start space-x-2">
                            <div class="w-6 h-6 bg-primary rounded-full flex items-center justify-center flex-shrink-0">
                                <i class="fas fa-robot text-white text-xs"></i>
                            </div>
                            <div class="flex-1">
                                <div class="bg-white rounded-lg p-3 shadow-card">
                                    <p class="text-sm text-text-primary">${message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                }
                
                chatHistory.appendChild(messageDiv);
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // 显示/隐藏生成状态
            function showGenerationStatus(show) {
                const statusDiv = document.querySelector('#generation-status');
                if (show) {
                    statusDiv.classList.remove('hidden');
                } else {
                    statusDiv.classList.add('hidden');
                }
            }

            // 更新预览图片（模拟）
            function updatePreviewImage() {
                const previewImage = document.querySelector('#preview-image');
                const images = [
                    'https://s.coze.cn/image/gxeIMLuExKY/',
                    'https://s.coze.cn/image/wmNDbHUS2_Q/',
                    'https://s.coze.cn/image/KPSQ_WIngMY/',
                    'https://s.coze.cn/image/LhBCjahW-Ks/'
                ];
                
                const currentSrc = previewImage.src;
                const currentIndex = images.findIndex(img => currentSrc.includes(img.split('/').pop()));
                const nextIndex = (currentIndex + 1) % images.length;
                
                previewImage.src = images[nextIndex];
            }

            // 响应式处理
            function handleResize() {
                const width = window.innerWidth;
                const modalContent = document.querySelector('#modal-content');
                
                if (width < 1024) {
                    // 小屏幕：调整布局
                    modalContent.classList.add('space-y-4');
                } else {
                    // 大屏幕：恢复布局
                    modalContent.classList.remove('space-y-4');
                }
            }

            window.addEventListener('resize', handleResize);
            handleResize(); // 初始化检查
        });
    </script>
</body>
</html>