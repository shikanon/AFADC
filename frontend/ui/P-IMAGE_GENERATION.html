<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>分镜画面生成与编辑 - AI漫剧快造</title>
    <script src="https://unpkg.byted-static.com/coze/space_ppt_lib/1.0.3-alpha.12/lib/tailwindcss.js"></script>
    <script src="https://unpkg.byted-static.com/fortawesome/fontawesome-free/6.7.2/js/all.min.js" data-auto-replace-svg="nest"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#6366f1',
                        secondary: '#8b5cf6',
                        tertiary: '#06b6d4',
                        success: '#10b981',
                        danger: '#ef4444',
                        warning: '#f59e0b',
                        info: '#3b82f6',
                        'text-primary': '#1f2937',
                        'text-secondary': '#6b7280',
                        'bg-light': '#f8fafc',
                        'border-light': '#e5e7eb'
                    },
                    boxShadow: {
                        'card': '0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06)',
                        'card-hover': '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)'
                    }
                }
            }
        }
    </script>
    <style>
        .sidebar-transition {
            transition: width 0.3s ease-in-out;
        }
        
        .shot-card-hover:hover {
            transform: translateY(-2px);
            transition: all 0.2s ease-in-out;
        }
        
        .nav-item-active {
            background-color: theme('colors.primary');
            color: white;
        }
        
        .nav-item-hover:hover {
            background-color: theme('colors.bg-light');
            color: theme('colors.primary');
        }
        
        .search-focus:focus {
            outline: none;
            border-color: theme('colors.primary');
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .progress-bar {
            transition: width 0.3s ease-in-out;
        }

        .shot-status-generating {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
</head>
<body class="bg-bg-light min-h-screen">
    <!-- 顶部导航栏 -->
    <header id="top-navbar" class="fixed top-0 left-0 right-0 bg-white border-b border-border-light h-16 z-50">
        <div class="flex items-center justify-between h-full px-6">
            <!-- Logo和产品名称 -->
            <div id="logo-section" class="flex items-center space-x-3">
                <div class="w-8 h-8 bg-gradient-to-br from-primary to-secondary rounded-lg flex items-center justify-center">
                    <i class="fas fa-magic text-white text-sm"></i>
                </div>
                <h1 class="text-xl font-bold text-text-primary">AI漫剧快造</h1>
            </div>
            
            <!-- 全局搜索 -->
            <div id="global-search" class="flex-1 max-w-md mx-8">
                <div class="relative">
                    <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-text-secondary text-sm"></i>
                    <input type="text" id="global-search-input" placeholder="搜索项目、工作空间..." 
                           class="w-full pl-10 pr-4 py-2 border border-border-light rounded-lg search-focus">
                </div>
            </div>
            
            <!-- 右侧操作区 -->
            <div id="header-actions" class="flex items-center space-x-4">
                <!-- 消息通知 -->
                <button id="notification-btn" class="relative p-2 text-text-secondary hover:text-primary">
                    <i class="fas fa-bell text-lg"></i>
                    <span class="absolute -top-1 -right-1 w-3 h-3 bg-danger rounded-full"></span>
                </button>
                
                <!-- 用户头像 -->
                <div id="user-menu" class="relative">
                    <button id="user-avatar-btn" class="flex items-center space-x-2 p-1 rounded-lg hover:bg-bg-light">
                        <img src="https://s.coze.cn/image/EuFy7laAT1w/" 
                             alt="用户头像" class="w-8 h-8 rounded-full" data-category="人物">
                        <span class="text-sm text-text-primary">张小明</span>
                        <i class="fas fa-chevron-down text-xs text-text-secondary"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 左侧菜单 -->
    <aside id="sidebar" class="fixed left-0 top-16 bottom-0 w-60 bg-white border-r border-border-light sidebar-transition z-40">
        <nav id="sidebar-nav" class="p-4 space-y-2">
            <!-- 工作空间 -->
            <div id="workspace-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">工作空间</h3>
                <div class="space-y-1">
                    <a href="P-WORKSPACE_LIST.html" id="nav-workspace-list" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-layer-group w-4"></i>
                        <span>工作空间管理</span>
                    </a>
                </div>
            </div>
            
            <!-- 项目管理 -->
            <div id="project-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">项目管理</h3>
                <div class="space-y-1">
                    <a href="P-PROJECT_LIST.html" id="nav-project-list" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-folder w-4"></i>
                        <span>项目列表</span>
                    </a>
                </div>
            </div>
            
            <!-- 制作流程 -->
            <div id="workflow-section" class="mb-6">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">制作流程</h3>
                <div class="space-y-1">
                    <a href="P-SCRIPT_INFO.html" id="nav-script-info" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-file-alt w-4"></i>
                        <span>剧本信息</span>
                    </a>
                    <a href="P-CHARACTER_GENERATION.html" id="nav-character" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-user-friends w-4"></i>
                        <span>角色IP形象</span>
                    </a>
                    <a href="P-VOICE_SELECTION.html" id="nav-voice" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-microphone w-4"></i>
                        <span>音色选择</span>
                    </a>
                    <a href="P-SCENARIO_EDITOR.html" id="nav-scenario" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-film w-4"></i>
                        <span>分镜脚本</span>
                    </a>
                    <a href="P-IMAGE_GENERATION.html" id="nav-image" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-active">
                        <i class="fas fa-image w-4"></i>
                        <span>分镜画面</span>
                    </a>
                    <a href="P-VIDEO_GENERATION.html" id="nav-video" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-video w-4"></i>
                        <span>分镜视频</span>
                    </a>
                    <a href="P-VIDEO_EXPORT.html" id="nav-export" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-download w-4"></i>
                        <span>视频导出</span>
                    </a>
                </div>
            </div>
            
            <!-- 素材库 -->
            <div id="material-section">
                <h3 class="text-xs font-semibold text-text-secondary uppercase tracking-wider mb-3">素材库</h3>
                <div class="space-y-1">
                    <a href="P-MATERIAL_LIBRARY.html" id="nav-material" 
                       class="flex items-center space-x-3 px-3 py-2 rounded-lg text-sm nav-item-hover">
                        <i class="fas fa-palette w-4"></i>
                        <span>素材库管理</span>
                    </a>
                </div>
            </div>
        </nav>
    </aside>

    <!-- 主内容区 -->
    <main id="main-content" class="ml-60 mt-16 p-6 min-h-screen">
        <!-- 页面头部 -->
        <div id="page-header" class="mb-6">
            <!-- 面包屑导航 -->
            <nav id="breadcrumb" class="mb-4">
                <ol class="flex items-center space-x-2 text-sm text-text-secondary">
                    <li><a href="P-PROJECT_LIST.html" class="hover:text-primary">项目管理</a></li>
                    <li><i class="fas fa-chevron-right text-xs"></i></li>
                    <li><span class="text-text-primary">樱花之恋</span></li>
                    <li><i class="fas fa-chevron-right text-xs"></i></li>
                    <li><span class="text-text-primary">分镜画面生成与编辑</span></li>
                </ol>
            </nav>
            
            <!-- 页面标题和操作 -->
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-2xl font-bold text-text-primary mb-2">分镜画面生成与编辑</h1>
                    <p class="text-text-secondary">生成和调整分镜画面，打造完美的视觉效果</p>
                </div>
                <div class="flex items-center space-x-3">
                    <button id="batch-generate-btn" class="bg-primary text-white px-6 py-2 rounded-lg hover:bg-primary/90 transition-colors">
                        <i class="fas fa-magic mr-2"></i>批量生成分镜画面
                    </button>
                    <button id="save-btn" class="bg-white border border-border-light text-text-primary px-6 py-2 rounded-lg hover:bg-bg-light transition-colors">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
            </div>
        </div>

        <!-- 生成进度条 -->
        <div id="generation-progress" class="bg-white rounded-xl shadow-card p-4 mb-6 hidden">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-text-primary">正在生成分镜画面</h3>
                <span id="progress-text" class="text-sm text-text-secondary">0/5</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-2">
                <div id="progress-bar" class="bg-primary h-2 rounded-full progress-bar" style="width: 0%"></div>
            </div>
            <div class="mt-3 text-sm text-text-secondary">
                <span id="current-task">正在处理分镜 1...</span>
            </div>
        </div>

        <!-- 分镜画面列表 -->
        <div id="shot-images-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <!-- 分镜画面1 -->
            <div id="shot-image-1" class="bg-white rounded-xl shadow-card shot-card-hover">
                <div class="relative">
                    <img src="https://s.coze.cn/image/_ZnXle0u2l4/" 
                         alt="樱花飞舞的校园场景，女主角站在樱花树下" class="w-full h-48 object-cover rounded-t-xl" data-category="艺术">
                    <div class="absolute top-3 right-3">
                        <span class="bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">已完成</span>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-black/50 text-white px-2 py-1 rounded-full text-xs font-medium">分镜 1</span>
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-semibold text-text-primary mb-3">樱花飞舞的校园</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">生成提示词</label>
                        <textarea id="prompt-1" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm resize-none" rows="3"
                                  placeholder="描述画面内容...">樱花飞舞的校园场景，女主角穿着蓝色校服站在樱花树下，背景是教学楼，温暖的春日阳光</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">关联角色</label>
                        <select id="character-1" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm">
                            <option value="">选择角色</option>
                            <option value="character-1" selected>女主角 - 小雨</option>
                            <option value="character-2">男主角 - 小风</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between space-x-2">
                        <button id="regenerate-1" class="flex-1 bg-warning/10 text-warning px-3 py-2 rounded-lg text-sm hover:bg-warning/20 transition-colors">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                        <button id="edit-1" class="flex-1 bg-primary/10 text-primary px-3 py-2 rounded-lg text-sm hover:bg-primary/20 transition-colors">
                            <i class="fas fa-edit mr-1"></i>独立修改
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分镜画面2 -->
            <div id="shot-image-2" class="bg-white rounded-xl shadow-card shot-card-hover">
                <div class="relative">
                    <img src="https://s.coze.cn/image/20X6k9zmMyQ/" 
                         alt="教室内部场景，学生们在上课" class="w-full h-48 object-cover rounded-t-xl" data-category="艺术">
                    <div class="absolute top-3 right-3">
                        <span class="bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">已完成</span>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-black/50 text-white px-2 py-1 rounded-full text-xs font-medium">分镜 2</span>
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-semibold text-text-primary mb-3">教室场景</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">生成提示词</label>
                        <textarea id="prompt-2" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm resize-none" rows="3"
                                  placeholder="描述画面内容...">明亮的教室内部，学生们正在上课，阳光透过窗户洒在课桌上，黑板上写着数学公式</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">关联角色</label>
                        <select id="character-2" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm">
                            <option value="">选择角色</option>
                            <option value="character-1">女主角 - 小雨</option>
                            <option value="character-2" selected>男主角 - 小风</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between space-x-2">
                        <button id="regenerate-2" class="flex-1 bg-warning/10 text-warning px-3 py-2 rounded-lg text-sm hover:bg-warning/20 transition-colors">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                        <button id="edit-2" class="flex-1 bg-primary/10 text-primary px-3 py-2 rounded-lg text-sm hover:bg-primary/20 transition-colors">
                            <i class="fas fa-edit mr-1"></i>独立修改
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分镜画面3 -->
            <div id="shot-image-3" class="bg-white rounded-xl shadow-card shot-card-hover">
                <div class="relative">
                    <img src="https://s.coze.cn/image/ghWeUClrO6A/" 
                         alt="图书馆安静的阅读角落" class="w-full h-48 object-cover rounded-t-xl" data-category="艺术">
                    <div class="absolute top-3 right-3">
                        <span class="bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium">已完成</span>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-black/50 text-white px-2 py-1 rounded-full text-xs font-medium">分镜 3</span>
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-semibold text-text-primary mb-3">图书馆相遇</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">生成提示词</label>
                        <textarea id="prompt-3" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm resize-none" rows="3"
                                  placeholder="描述画面内容...">安静的图书馆角落，女主角正在看书，男主角轻轻走过来，两人目光相遇的温馨场景</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">关联角色</label>
                        <select id="character-3" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm">
                            <option value="">选择角色</option>
                            <option value="character-1" selected>女主角 - 小雨</option>
                            <option value="character-2" selected>男主角 - 小风</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between space-x-2">
                        <button id="regenerate-3" class="flex-1 bg-warning/10 text-warning px-3 py-2 rounded-lg text-sm hover:bg-warning/20 transition-colors">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                        <button id="edit-3" class="flex-1 bg-primary/10 text-primary px-3 py-2 rounded-lg text-sm hover:bg-primary/20 transition-colors">
                            <i class="fas fa-edit mr-1"></i>独立修改
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分镜画面4 -->
            <div id="shot-image-4" class="bg-white rounded-xl shadow-card shot-card-hover">
                <div class="relative">
                    <div class="w-full h-48 bg-gray-100 rounded-t-xl flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-image text-4xl text-text-secondary mb-2"></i>
                            <p class="text-sm text-text-secondary">等待生成</p>
                        </div>
                    </div>
                    <div class="absolute top-3 right-3">
                        <span class="bg-info/10 text-info px-2 py-1 rounded-full text-xs font-medium">待生成</span>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-black/50 text-white px-2 py-1 rounded-full text-xs font-medium">分镜 4</span>
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-semibold text-text-primary mb-3">黄昏的操场</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">生成提示词</label>
                        <textarea id="prompt-4" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm resize-none" rows="3"
                                  placeholder="描述画面内容...">黄昏时分的操场，夕阳西下，男女主角并肩走在跑道上，影子被拉得很长</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">关联角色</label>
                        <select id="character-4" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm">
                            <option value="">选择角色</option>
                            <option value="character-1" selected>女主角 - 小雨</option>
                            <option value="character-2" selected>男主角 - 小风</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between space-x-2">
                        <button id="regenerate-4" class="flex-1 bg-warning/10 text-warning px-3 py-2 rounded-lg text-sm hover:bg-warning/20 transition-colors">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                        <button id="edit-4" class="flex-1 bg-primary/10 text-primary px-3 py-2 rounded-lg text-sm hover:bg-primary/20 transition-colors">
                            <i class="fas fa-edit mr-1"></i>独立修改
                        </button>
                    </div>
                </div>
            </div>

            <!-- 分镜画面5 -->
            <div id="shot-image-5" class="bg-white rounded-xl shadow-card shot-card-hover">
                <div class="relative">
                    <div class="w-full h-48 bg-gray-100 rounded-t-xl flex items-center justify-center">
                        <div class="text-center">
                            <i class="fas fa-image text-4xl text-text-secondary mb-2"></i>
                            <p class="text-sm text-text-secondary">等待生成</p>
                        </div>
                    </div>
                    <div class="absolute top-3 right-3">
                        <span class="bg-info/10 text-info px-2 py-1 rounded-full text-xs font-medium">待生成</span>
                    </div>
                    <div class="absolute top-3 left-3">
                        <span class="bg-black/50 text-white px-2 py-1 rounded-full text-xs font-medium">分镜 5</span>
                    </div>
                </div>
                <div class="p-5">
                    <h3 class="font-semibold text-text-primary mb-3">星空下的约定</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">生成提示词</label>
                        <textarea id="prompt-5" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm resize-none" rows="3"
                                  placeholder="描述画面内容...">夜晚的校园天台，满天繁星，男女主角坐在栏杆上，许下约定的浪漫场景</textarea>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-text-secondary mb-2">关联角色</label>
                        <select id="character-5" class="w-full px-3 py-2 border border-border-light rounded-lg text-sm">
                            <option value="">选择角色</option>
                            <option value="character-1" selected>女主角 - 小雨</option>
                            <option value="character-2" selected>男主角 - 小风</option>
                        </select>
                    </div>
                    <div class="flex items-center justify-between space-x-2">
                        <button id="regenerate-5" class="flex-1 bg-warning/10 text-warning px-3 py-2 rounded-lg text-sm hover:bg-warning/20 transition-colors">
                            <i class="fas fa-redo mr-1"></i>重新生成
                        </button>
                        <button id="edit-5" class="flex-1 bg-primary/10 text-primary px-3 py-2 rounded-lg text-sm hover:bg-primary/20 transition-colors">
                            <i class="fas fa-edit mr-1"></i>独立修改
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 底部操作区 -->
        <div id="bottom-actions" class="bg-white rounded-xl shadow-card p-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <button id="prev-btn" class="px-6 py-2 border border-border-light text-text-primary rounded-lg hover:bg-bg-light transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>上一步
                    </button>
                    <button id="save-bottom-btn" class="px-6 py-2 border border-border-light text-text-primary rounded-lg hover:bg-bg-light transition-colors">
                        <i class="fas fa-save mr-2"></i>保存
                    </button>
                </div>
                <button id="next-btn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                    下一步<i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>
        </div>
    </main>

    <!-- 独立修改工作流弹窗 -->
    <div id="edit-workflow-modal" class="fixed inset-0 bg-black/50 z-50 hidden">
        <div class="flex items-center justify-center min-h-screen p-4">
            <div class="bg-white rounded-xl shadow-xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
                <div class="p-6 border-b border-border-light">
                    <div class="flex items-center justify-between">
                        <h3 class="text-lg font-semibold text-text-primary">独立修改分镜画面</h3>
                        <button id="close-workflow-modal-btn" class="text-text-secondary hover:text-text-primary">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <p class="text-sm text-text-secondary mt-1">与AI对话，精细调整画面效果</p>
                </div>
                
                <div class="flex flex-col h-[calc(90vh-120px)]">
                    <!-- 当前画面预览 -->
                    <div class="p-6 border-b border-border-light">
                        <h4 class="font-medium text-text-primary mb-3">当前画面</h4>
                        <img id="current-image-preview" src="https://s.coze.cn/image/wc9x7ikKG5Q/" 
                             alt="当前分镜画面" class="w-full max-w-md rounded-lg" data-category="艺术">
                    </div>
                    
                    <!-- AI对话区域 -->
                    <div class="flex-1 flex flex-col">
                        <div class="p-6 border-b border-border-light">
                            <h4 class="font-medium text-text-primary mb-3">AI助手</h4>
                            <div class="bg-primary/5 rounded-lg p-4">
                                <div class="flex items-start space-x-3">
                                    <div class="w-8 h-8 bg-primary rounded-full flex items-center justify-center">
                                        <i class="fas fa-robot text-white text-sm"></i>
                                    </div>
                                    <div class="flex-1">
                                        <p class="text-sm text-text-primary">你好！我可以帮你调整这个分镜画面。你希望做哪些修改呢？比如调整角色表情、改变背景、调整光线效果等。</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 对话历史 -->
                        <div id="chat-history" class="flex-1 p-6 overflow-y-auto">
                            <!-- 对话内容将动态添加 -->
                        </div>
                        
                        <!-- 输入区域 -->
                        <div class="p-6 border-t border-border-light">
                            <div class="flex space-x-3">
                                <textarea id="chat-input" 
                                          class="flex-1 px-4 py-3 border border-border-light rounded-lg resize-none focus:outline-none focus:border-primary focus:ring-2 focus:ring-primary/20" 
                                          rows="3" placeholder="描述你希望的画面修改..."></textarea>
                                <button id="send-chat-btn" class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                    <i class="fas fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 底部操作 -->
                    <div class="p-6 border-t border-border-light">
                        <div class="flex items-center justify-between">
                            <button id="cancel-edit-btn" class="px-4 py-2 border border-border-light text-text-secondary rounded-lg hover:border-primary hover:text-primary">
                                取消
                            </button>
                            <button id="apply-changes-btn" class="px-6 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors">
                                <i class="fas fa-check mr-2"></i>应用修改
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 解析URL参数的辅助函数
            function getUrlParams() {
                const params = {};
                const queryString = window.location.search.substring(1);
                const urlParams = new URLSearchParams(queryString);
                
                for(const [key, value] of urlParams.entries()) {
                    params[key] = value;
                }
                return params;
            }

            // 获取URL参数
            const params = getUrlParams();
            const projectId = params.projectId || 'default-project';

            // 批量生成分镜画面
            document.querySelector('#batch-generate-btn').addEventListener('click', function() {
                console.log('开始批量生成分镜画面');
                showGenerationProgress();
                simulateBatchGeneration();
            });

            // 保存按钮
            document.querySelector('#save-btn').addEventListener('click', function() {
                saveChanges();
            });

            document.querySelector('#save-bottom-btn').addEventListener('click', function() {
                saveChanges();
            });

            // 上一步按钮
            document.querySelector('#prev-btn').addEventListener('click', function() {
                window.location.href = `P-SCENARIO_EDITOR.html?projectId=${projectId}`;
            });

            // 下一步按钮
            document.querySelector('#next-btn').addEventListener('click', function() {
                // 根据项目类型决定跳转到哪个页面
                // 这里假设当前项目是静态漫，实际应用中应该从项目数据获取
                const projectType = 'static'; // 可以从URL参数或项目数据中获取
                if (projectType === 'dynamic') {
                    window.location.href = `P-VIDEO_GENERATION.html?projectId=${projectId}`;
                } else {
                    window.location.href = `P-VIDEO_EXPORT.html?projectId=${projectId}`;
                }
            });

            // 重新生成按钮事件
            for (let i = 1; i <= 5; i++) {
                document.querySelector(`#regenerate-${i}`).addEventListener('click', function() {
                    regenerateSingleShot(i);
                });

                // 独立修改按钮事件
                document.querySelector(`#edit-${i}`).addEventListener('click', function() {
                    openEditWorkflow(i);
                });
            }

            // 独立修改工作流弹窗控制
            const editWorkflowModal = document.querySelector('#edit-workflow-modal');
            const closeWorkflowModalBtn = document.querySelector('#close-workflow-modal-btn');
            const cancelEditBtn = document.querySelector('#cancel-edit-btn');
            const applyChangesBtn = document.querySelector('#apply-changes-btn');
            const sendChatBtn = document.querySelector('#send-chat-btn');
            const chatInput = document.querySelector('#chat-input');

            function openEditWorkflow(shotId) {
                console.log(`打开分镜 ${shotId} 的独立修改工作流`);
                // 更新预览图片
                const currentImage = document.querySelector(`#shot-image-${shotId} img`);
                if (currentImage) {
                    document.querySelector('#current-image-preview').src = currentImage.src;
                    document.querySelector('#current-image-preview').alt = currentImage.alt;
                }
                editWorkflowModal.classList.remove('hidden');
            }

            function closeEditWorkflow() {
                editWorkflowModal.classList.add('hidden');
                // 清空对话历史
                document.querySelector('#chat-history').innerHTML = '';
                chatInput.value = '';
            }

            closeWorkflowModalBtn.addEventListener('click', closeEditWorkflow);
            cancelEditBtn.addEventListener('click', closeEditWorkflow);

            // 点击弹窗外部关闭
            editWorkflowModal.addEventListener('click', (e) => {
                if (e.target === editWorkflowModal) {
                    closeEditWorkflow();
                }
            });

            // 发送对话消息
            sendChatBtn.addEventListener('click', function() {
                const message = chatInput.value.trim();
                if (message) {
                    addChatMessage('user', message);
                    chatInput.value = '';
                    // 模拟AI回复
                    setTimeout(() => {
                        addChatMessage('ai', '我已经理解你的需求，正在为你调整画面...');
                    }, 1000);
                }
            });

            // 回车发送消息
            chatInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatBtn.click();
                }
            });

            // 应用修改
            applyChangesBtn.addEventListener('click', function() {
                console.log('应用分镜画面修改');
                // 这里应该调用API应用修改
                alert('修改已应用！');
                closeEditWorkflow();
            });

            // 添加对话消息
            function addChatMessage(role, content) {
                const chatHistory = document.querySelector('#chat-history');
                const messageDiv = document.createElement('div');
                messageDiv.className = `mb-4 ${role === 'user' ? 'flex justify-end' : 'flex justify-start'}`;
                
                const messageContent = document.createElement('div');
                messageContent.className = `${role === 'user' ? 'bg-primary text-white' : 'bg-gray-100 text-text-primary'} rounded-lg p-3 max-w-md`;
                messageContent.textContent = content;
                
                messageDiv.appendChild(messageContent);
                chatHistory.appendChild(messageDiv);
                
                // 滚动到底部
                chatHistory.scrollTop = chatHistory.scrollHeight;
            }

            // 显示生成进度
            function showGenerationProgress() {
                const progressDiv = document.querySelector('#generation-progress');
                progressDiv.classList.remove('hidden');
            }

            // 隐藏生成进度
            function hideGenerationProgress() {
                const progressDiv = document.querySelector('#generation-progress');
                progressDiv.classList.add('hidden');
            }

            // 模拟批量生成过程
            function simulateBatchGeneration() {
                let currentProgress = 0;
                const totalShots = 5;
                const progressBar = document.querySelector('#progress-bar');
                const progressText = document.querySelector('#progress-text');
                const currentTask = document.querySelector('#current-task');

                const interval = setInterval(() => {
                    currentProgress++;
                    const percentage = (currentProgress / totalShots) * 100;
                    
                    progressBar.style.width = percentage + '%';
                    progressText.textContent = `${currentProgress}/${totalShots}`;
                    currentTask.textContent = `正在处理分镜 ${currentProgress}...`;

                    if (currentProgress >= totalShots) {
                        clearInterval(interval);
                        setTimeout(() => {
                            hideGenerationProgress();
                            alert('分镜画面批量生成完成！');
                            // 更新所有分镜画面状态为已完成
                            updateAllShotsToCompleted();
                        }, 1000);
                    }
                }, 1000);
            }

            // 重新生成单个分镜
            function regenerateSingleShot(shotId) {
                console.log(`重新生成分镜 ${shotId}`);
                const shotCard = document.querySelector(`#shot-image-${shotId}`);
                const statusBadge = shotCard.querySelector('.absolute.top-3.right-3 span');
                
                // 更新状态为生成中
                statusBadge.textContent = '生成中';
                statusBadge.className = 'bg-warning/10 text-warning px-2 py-1 rounded-full text-xs font-medium shot-status-generating';
                
                // 模拟生成过程
                setTimeout(() => {
                    statusBadge.textContent = '已完成';
                    statusBadge.className = 'bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium';
                    
                    // 更新图片（这里使用不同的图片URL模拟）
                    const imageUrls = [
                        'https://s.coze.cn/image/Y33CTLcm3lg/',
                        'https://s.coze.cn/image/2s9OFljy5nE/',
                        'https://s.coze.cn/image/2PlkuKb_6L0/',
                        'https://s.coze.cn/image/79E0Jyy9Szk/',
                        'https://s.coze.cn/image/LUKKTUUEnwk/'
                    ];
                    
                    const randomImageUrl = imageUrls[Math.floor(Math.random() * imageUrls.length)];
                    const shotImage = shotCard.querySelector('img');
                    if (shotImage) {
                        shotImage.src = randomImageUrl;
                    }
                    
                    alert(`分镜 ${shotId} 重新生成完成！`);
                }, 3000);
            }

            // 更新所有分镜为已完成状态
            function updateAllShotsToCompleted() {
                for (let i = 1; i <= 5; i++) {
                    const shotCard = document.querySelector(`#shot-image-${i}`);
                    const statusBadge = shotCard.querySelector('.absolute.top-3.right-3 span');
                    const placeholderImage = shotCard.querySelector('.fa-image');
                    
                    if (statusBadge) {
                        statusBadge.textContent = '已完成';
                        statusBadge.className = 'bg-success/10 text-success px-2 py-1 rounded-full text-xs font-medium';
                    }
                    
                    // 如果是占位符，替换为实际图片
                    if (placeholderImage) {
                        const imageContainer = placeholderImage.closest('.bg-gray-100');
                        const imageUrls = [
                            'https://s.coze.cn/image/hc2qECHShOA/',
                            'https://s.coze.cn/image/i-sDduv3eMI/',
                            'https://s.coze.cn/image/AyMDv9JkZEU/',
                            'https://s.coze.cn/image/POs-JKwIMRs/',
                            'https://s.coze.cn/image/r6yCZAxOcBI/'
                        ];
                        
                        imageContainer.innerHTML = `
                            <img src="${imageUrls[i-1]}" 
                                 alt="分镜 ${i} 画面" 
                                 class="w-full h-full object-cover rounded-t-xl" 
                                 data-category="艺术">
                        `;
                    }
                }
            }

            // 保存修改
            function saveChanges() {
                console.log('保存分镜画面修改');
                
                // 收集所有分镜的数据
                const shotData = [];
                for (let i = 1; i <= 5; i++) {
                    const prompt = document.querySelector(`#prompt-${i}`).value;
                    const character = document.querySelector(`#character-${i}`).value;
                    
                    shotData.push({
                        shotId: i,
                        prompt: prompt,
                        character: character
                    });
                }
                
                console.log('保存的数据:', shotData);
                
                // 显示保存成功提示
                const saveBtn = document.querySelector('#save-btn');
                const originalText = saveBtn.innerHTML;
                saveBtn.innerHTML = '<i class="fas fa-check mr-2"></i>已保存';
                saveBtn.className = 'bg-success text-white px-6 py-2 rounded-lg';
                
                setTimeout(() => {
                    saveBtn.innerHTML = originalText;
                    saveBtn.className = 'bg-white border border-border-light text-text-primary px-6 py-2 rounded-lg hover:bg-bg-light transition-colors';
                }, 2000);
            }

            // 提示词输入框自动保存
            for (let i = 1; i <= 5; i++) {
                const promptInput = document.querySelector(`#prompt-${i}`);
                let autoSaveTimeout;
                
                promptInput.addEventListener('input', function() {
                    clearTimeout(autoSaveTimeout);
                    autoSaveTimeout = setTimeout(() => {
                        console.log(`分镜 ${i} 提示词已自动保存`);
                    }, 2000);
                });
            }

            // 角色选择变化事件
            for (let i = 1; i <= 5; i++) {
                const characterSelect = document.querySelector(`#character-${i}`);
                characterSelect.addEventListener('change', function() {
                    console.log(`分镜 ${i} 角色已更改为: ${this.value}`);
                });
            }
        });
    </script>
</body>
</html>